{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Back Button & Header -->
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center space-x-4">
            <a href="{% url 'houses:detail' house.id %}" 
               class="inline-flex items-center space-x-2 text-gray-400 hover:text-white transition">
                <i class="fas fa-arrow-left"></i>
                <span>Back to House</span>
            </a>
        </div>
        
        <div class="text-right">
            <h1 class="text-4xl font-bold text-accent">{{ house.name }} Members</h1>
            <p class="text-gray-400">{{ members.count }} dedicated members</p>
        </div>
    </div>

    <!-- House Banner -->
    <div class="bg-gradient-to-br from-red-900/30 to-black/30 rounded-2xl p-6 border border-red-800/50 backdrop-blur-sm mb-8">
        <div class="flex items-center space-x-6">
            <img src="{{ house.crest.url }}" 
                 alt="{{ house.name }} Crest" 
                 class="w-20 h-20 object-contain bg-black/30 rounded-xl p-2 border border-red-800/30">
            <div>
                <h2 class="text-2xl font-bold text-white">{{ house.name }}</h2>
                <p class="text-gray-300 italic">"{{ house.motto }}"</p>
            </div>
            <div class="ml-auto flex items-center space-x-4">
                <div class="text-center">
                    <div class="text-3xl font-bold text-accent">{{ members.count }}</div>
                    <div class="text-gray-400 text-sm">Total Members</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-accent">{{ admins_count }}</div>
                    <div class="text-gray-400 text-sm">Admins</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="bg-gradient-to-br from-red-900/30 to-black/30 rounded-2xl p-6 border border-red-800/50 backdrop-blur-sm mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
            <div class="flex-1 md:max-w-md">
                <div class="relative">
                    <input type="text" 
                           id="member-search" 
                           placeholder="Search members by name or matric number..." 
                           class="w-full px-4 py-3 pl-10 bg-black/30 border border-red-800/50 rounded-lg text-white placeholder-gray-500 focus:border-accent focus:ring-1 focus:ring-accent">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                </div>
            </div>
            
            <div class="flex space-x-4">
                <select id="role-filter" 
                        class="px-4 py-3 bg-black/30 border border-red-800/50 rounded-lg text-white focus:border-accent focus:ring-1 focus:ring-accent">
                    <option value="all">All Roles</option>
                    <option value="admin">Admins Only</option>
                    <option value="student">Students Only</option>
                </select>
                
                <select id="sort-by" 
                        class="px-4 py-3 bg-black/30 border border-red-800/50 rounded-lg text-white focus:border-accent focus:ring-1 focus:ring-accent">
                    <option value="name">Sort by Name</option>
                    <option value="role">Sort by Role</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Members Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="members-container">
        {% for member in members %}
        <div class="bg-gradient-to-br from-red-900/30 to-black/30 rounded-2xl p-6 border border-red-800/50 backdrop-blur-sm hover:border-accent/50 transition group member-card" 
             data-name="{{ member.name|lower }}">
            <div class="text-center">
                <!-- Member Avatar -->
                <div class="relative inline-block mb-4">
                    <div class="w-20 h-20 bg-red-800/30 rounded-full flex items-center justify-center border-2 {% if member.role == 'admin' %}border-red-500{% elif member == user %}border-accent{% else %}border-red-800/50{% endif %} group-hover:border-accent transition">
                        <i class="fas fa-user text-2xl {% if member.role == 'admin' %}text-red-400{% elif member == user %}text-accent{% else %}text-gray-400{% endif %}"></i>
                    </div>
                    
                    <!-- Role Badge -->
                    {% if member.role == 'admin' %}
                    <div class="absolute -top-2 -right-2 w-8 h-8 bg-red-600 rounded-full flex items-center justify-center border-2 border-black">
                        <i class="fas fa-crown text-white text-xs"></i>
                    </div>
                    {% elif member == user %}
                    <div class="absolute -top-2 -right-2 w-8 h-8 bg-accent rounded-full flex items-center justify-center border-2 border-black">
                        <i class="fas fa-star text-black text-xs"></i>
                    </div>
                    {% endif %}
                </div>

                <!-- Member Info -->
                <h3 class="font-bold text-white text-lg mb-1">{{ member.name }}</h3>
                
                <!-- Role Display -->
                <div class="mb-4">
                    {% if member.role == 'admin' %}
                    <span class="px-3 py-1 bg-red-600/20 text-red-400 rounded-full text-xs font-semibold border border-red-600/50">
                        House Admin
                    </span>
                    {% else %}
                    <span class="px-3 py-1 bg-gray-600/20 text-gray-400 rounded-full text-xs font-semibold border border-gray-600/50">
                        Member
                    </span>
                    {% endif %}
                    
                    {% if member == user %}
                    <span class="px-3 py-1 bg-accent/20 text-accent rounded-full text-xs font-semibold border border-accent/50 ml-2">
                        You
                    </span>
                    {% endif %}
                </div>

                <!-- Member Stats -->
                <div class="grid grid-cols-2 gap-4 text-center mb-4">
                    <div>
                        <div class="text-lg font-bold text-accent">{{ member.images_uploaded }}</div>
                        <div class="text-gray-400 text-xs">Photos</div>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-accent">{{ member.qr_scans }}</div>
                        <div class="text-gray-400 text-xs">QR Scans</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-2">
                    
                    {% if user.role == 'admin' and member != user %}
                    <button class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-xs">
                        <i class="fas fa-cog"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-12">
            <i class="fas fa-users text-gray-600 text-5xl mb-4"></i>
            <h3 class="text-2xl font-bold text-gray-400 mb-2">No Members Found</h3>
            <p class="text-gray-500">This house doesn't have any members yet.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Members Statistics -->
    <div class="mt-12 bg-gradient-to-br from-red-900/30 to-black/30 rounded-2xl p-8 border border-red-800/50 backdrop-blur-sm">
        <h2 class="text-3xl font-bold text-accent mb-6">Members Statistics</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-black/20 rounded-xl p-6 text-center border border-red-800/30">
                <div class="text-3xl font-bold text-accent mb-2">{{ members.count }}</div>
                <div class="text-gray-400">Total Members</div>
            </div>
            
            <div class="bg-black/20 rounded-xl p-6 text-center border border-red-800/30">
                <div class="text-3xl font-bold text-green-500 mb-2">{{ active_members }}</div>
                <div class="text-gray-400">Active Members</div>
            </div>
            
            <div class="bg-black/20 rounded-xl p-6 text-center border border-red-800/30">
                <div class="text-3xl font-bold text-blue-500 mb-2">{{ admins_count }}</div>
                <div class="text-gray-400">House Admins</div>
            </div>
            
            <div class="bg-black/20 rounded-xl p-6 text-center border border-red-800/30">
                <div class="text-3xl font-bold text-purple-500 mb-2">{{ new_members_today }}</div>
                <div class="text-gray-400">Joined Today</div>
            </div>
        </div>

        <!-- Role Distribution -->
        <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-black/20 rounded-xl p-6 border border-red-800/30">
                <h3 class="text-xl font-bold text-accent mb-4">Role Distribution</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-4 h-4 bg-red-600 rounded-full"></div>
                            <span class="text-white">Admins</span>
                        </div>
                        <span class="text-accent font-bold">{{ admins_count }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-4 h-4 bg-accent rounded-full"></div>
                            <span class="text-white">Students</span>
                        </div>
                        <span class="text-accent font-bold">{{ students_count }}</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-black/20 rounded-xl p-6 border border-red-800/30">
                <h3 class="text-xl font-bold text-accent mb-4">Activity Overview</h3>
                <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">Total Photos Uploaded</span>
                        <span class="text-white font-semibold">{{ total_photos_uploaded }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">Total QR Scans</span>
                        <span class="text-white font-semibold">{{ total_qr_scans }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">Average Activity</span>
                        <span class="text-white font-semibold">{{ average_activity }}%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Font Awesome -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>

<style>
    /* Smooth transitions */
    .member-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .member-card:hover {
        transform: translateY(-5px);
    }
    
    /* Custom input styling */
    input, select {
        background: rgba(0, 0, 0, 0.3) !important;
        border: 1px solid rgba(139, 0, 0, 0.5) !important;
        color: white !important;
    }
    
    input:focus, select:focus {
        border-color: #FF6B35 !important;
        box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.2) !important;
        outline: none !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('member-search');
        const roleFilter = document.getElementById('role-filter');
        const sortBy = document.getElementById('sort-by');
        const memberCards = document.querySelectorAll('.member-card');
        
        function filterAndSortMembers() {
            const searchTerm = searchInput.value.toLowerCase();
            const roleValue = roleFilter.value;
            const sortValue = sortBy.value;
            
            let visibleMembers = [];
            
            // Filter members
            memberCards.forEach(card => {
                const name = card.dataset.name;
                const matric = card.dataset.matric;
                const role = card.dataset.role;
                
                const matchesSearch = name.includes(searchTerm) || matric.includes(searchTerm);
                const matchesRole = roleValue === 'all' || role === roleValue;
                
                if (matchesSearch && matchesRole) {
                    card.style.display = 'block';
                    visibleMembers.push(card);
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Sort members
            visibleMembers.sort((a, b) => {
                if (sortValue === 'name') {
                    return a.dataset.name.localeCompare(b.dataset.name);
                } else if (sortValue === 'matric') {
                    return a.dataset.matric.localeCompare(b.dataset.matric);
                } else if (sortValue === 'role') {
                    return a.dataset.role.localeCompare(b.dataset.role);
                }
                return 0;
            });
            
            // Reorder in DOM
            const container = document.getElementById('members-container');
            visibleMembers.forEach(card => {
                container.appendChild(card);
            });
            
            // Show empty state if no results
            const visibleCount = visibleMembers.length;
            const emptyState = document.querySelector('.col-span-full');
            if (emptyState) {
                if (visibleCount === 0 && searchTerm) {
                    emptyState.style.display = 'block';
                    emptyState.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-search text-gray-600 text-5xl mb-4"></i>
                            <h3 class="text-2xl font-bold text-gray-400 mb-2">No Members Found</h3>
                            <p class="text-gray-500">No members match your search criteria.</p>
                        </div>
                    `;
                } else if (visibleCount === 0) {
                    emptyState.style.display = 'block';
                } else {
                    emptyState.style.display = 'none';
                }
            }
        }
        
        // Event listeners
        searchInput.addEventListener('input', filterAndSortMembers);
        roleFilter.addEventListener('change', filterAndSortMembers);
        sortBy.addEventListener('change', filterAndSortMembers);
        
        // Initial filter
        filterAndSortMembers();
        
        // Add loading animation to cards
        memberCards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
            card.classList.add('animate-fade-in');
        });
    });
</script>
{% endblock %}